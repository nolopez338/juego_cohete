<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rocket Gate Game</title>

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #111;
        color: white;
        font-family: Arial;
    }

    #gameArea {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: #222;
        overflow: hidden;
    }

    #trailCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .rocket {
        position: absolute;
        width: 40px;
        height: 40px;
        background: red;
        border-radius: 50% 50% 0 0;
        transition: transform 0.1s;
        z-index: 3;
    }

    .gate {
        position: absolute;
        width: 20px;
        background: lime;
        z-index: 2;
    }

    #scoreDisplay {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 18px;
        background: rgba(0,0,0,0.4);
        padding: 10px 18px;
        border-radius: 10px;
        min-width: 220px;
        line-height: 22px;
        z-index: 10;
    }

    #gateInfo {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 16px;
        background: rgba(0,0,0,0.4);
        padding: 10px 15px;
        border-radius: 10px;
        z-index: 10;
        line-height: 20px;
    }

    #popupOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20;
    }

    #popupBox {
        background: #333;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        font-size: 20px;
        width: 250px;
    }

    /* CONTROL PANEL */
    #topControls {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
        background: rgba(0,0,0,0.4);
        padding: 10px 15px;
        border-radius: 10px;
        text-align: center;
    }

    .controlRow {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
    }

    .controlRow input[type="range"] {
        width: 180px;
    }

    .numInput {
        width: 60px;
        text-align: center;
        font-size: 16px;
        background: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 6px;
        padding: 3px;
    }
</style>
</head>

<body>

<div id="gameArea">

    <canvas id="trailCanvas"></canvas>

    <!-- CONTROL PANEL -->
    <div id="topControls">
        <div class="controlRow">
            <span>Y pos</span>
            <input type="range" id="ySlider" min="-100" max="100" value="0">
            <input type="number" id="yInput" class="numInput" min="-100" max="100" value="0">
        </div>

        <div class="controlRow">
            <span>Slope</span>
            <input type="range" id="slopeSlider" min="-10" max="10" step="0.1" value="0">
            <input type="number" id="slopeInput" class="numInput" min="-10" max="10" step="0.1" value="0">
        </div>
    </div>

    <!-- Gate Labels -->
    <div id="gateInfo">
        Gate X: <span id="gateXLabel">0</span><br>
        Gate Top Y: <span id="gateTopLabel">0</span><br>
        Gate Bottom Y: <span id="gateBottomLabel">0</span>
    </div>

    <div id="rocket" class="rocket"></div>
    <div id="gate" class="gate"></div>

    <div id="scoreDisplay">
        <span style="color:lime;">Hits:</span>
        <span id="hitsCount">0</span>
        <div id="hitsDots"></div>

        <span style="color:red;">Misses:</span>
        <span id="missCount">0</span>
        <div id="missDots"></div>
    </div>

    <div id="popupOverlay">
        <div id="popupBox">
            <div id="popupMessage"></div>
            <button id="popupBtn">OK</button>
        </div>
    </div>
</div>

<script>
// ELEMENTS
const rocket = document.getElementById("rocket");
const gameArea = document.getElementById("gameArea");
const gate = document.getElementById("gate");

const gateXLabel = document.getElementById("gateXLabel");
const gateTopLabel = document.getElementById("gateTopLabel");
const gateBottomLabel = document.getElementById("gateBottomLabel");

const ySlider = document.getElementById("ySlider");
const yInput = document.getElementById("yInput");

const slopeSlider = document.getElementById("slopeSlider");
const slopeInput = document.getElementById("slopeInput");

const canvas = document.getElementById("trailCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    canvas.width = gameArea.clientWidth;
    canvas.height = gameArea.clientHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// GAME STATE
let rocketX, rocketY;
let slope = 0;
let speed = 6;
let facing = "right";

let anim = null;
let lastTrailX = null;
let lastTrailY = null;

let inFlight = false;
let popupActive = false;
let roundFinished = false;

let hits = 0;
let misses = 0;

const gateWidth = 150;

// COORDINATE CONVERSION
function convertCenterToScreen(value) {
    const center = gameArea.clientHeight / 2;
    return center - value - rocket.clientHeight / 2;
}
function convertScreenToCenter(y) {
    const center = gameArea.clientHeight / 2;
    return -(y + rocket.clientHeight / 2 - center);
}

// SPAWN GATE
function spawnGate() {
    const gapY = Math.random() * (gameArea.clientHeight - gateWidth);

    gate.style.height = gateWidth + "px";
    gate.style.top = gapY + "px";

    const left = facing === "right"
        ? (gameArea.clientWidth - gate.clientWidth)
        : 0;

    gate.style.left = left + "px";

    gateXLabel.textContent = Math.round(left);
    gateTopLabel.textContent = Math.round(gapY);
    gateBottomLabel.textContent = Math.round(gapY + gateWidth);
}

// RESET
function resetRocket() {

    cancelAnimationFrame(anim);
    anim = null;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    lastTrailX = null;
    lastTrailY = null;

    rocketX = gameArea.clientWidth / 2 - rocket.clientWidth / 2;
    rocketY = gameArea.clientHeight / 2 - rocket.clientHeight / 2;

    rocket.style.left = rocketX + "px";
    rocket.style.top = rocketY + "px";

    slope = 0;
    slopeSlider.value = 0;
    slopeInput.value = 0;

    const c = convertScreenToCenter(rocketY);
    ySlider.value = c;
    yInput.value = c;

    inFlight = false;
    roundFinished = false;

    spawnGate();
}

// UPDATE Y BEFORE LAUNCH
function setRocketFromCenter(v) {
    if (inFlight || popupActive) return;

    const screenY = convertCenterToScreen(v);
    const maxY = gameArea.clientHeight - rocket.clientHeight;

    rocketY = Math.max(0, Math.min(maxY, screenY));
    rocket.style.top = rocketY + "px";
}

// Y SLIDERS
ySlider.addEventListener("input", () => {
    yInput.value = ySlider.value;
    setRocketFromCenter(parseInt(ySlider.value));
});

yInput.addEventListener("input", () => {
    let v = parseInt(yInput.value);
    if (isNaN(v)) v = 0;
    v = Math.max(-100, Math.min(100, v));
    yInput.value = v;
    ySlider.value = v;
    setRocketFromCenter(v);
});

// SLOPE SLIDERS
slopeSlider.addEventListener("input", () => {
    slope = parseFloat(slopeSlider.value);
    slopeInput.value = slope;
});

slopeInput.addEventListener("input", () => {
    let v = parseFloat(slopeInput.value);
    if (isNaN(v)) v = 0;
    v = Math.max(-10, Math.min(10, v));
    slopeInput.value = v;
    slopeSlider.value = v;
    slope = v;
});

// TRAIL
function drawTrail(x1, y1, x2, y2) {
    ctx.strokeStyle = "cyan";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
}

// ROTATION
function rotateRocket(dir) {
    if (inFlight || popupActive) return;
    facing = dir;
    rocket.style.transform = dir === "right"
        ? "rotate(90deg)"
        : "rotate(-90deg)";
}

// LAUNCH
function launchRocket() {
    if (inFlight || popupActive) return;
    inFlight = true;

    function update() {

        const prevX = rocketX + rocket.clientWidth / 2;
        const prevY = rocketY + rocket.clientHeight / 2;

        rocketX += facing === "right" ? speed : -speed;

        // ✔ FIX: INVERTED SLOPE SIGN
        rocketY -= slope;

        rocketY = Math.max(0, Math.min(gameArea.clientHeight - rocket.clientHeight, rocketY));

        rocket.style.left = rocketX + "px";
        rocket.style.top = rocketY + "px";

        const newX = rocketX + rocket.clientWidth / 2;
        const newY = rocketY + rocket.clientHeight / 2;

        if (lastTrailX !== null)
            drawTrail(prevX, prevY, newX, newY);

        lastTrailX = newX;
        lastTrailY = newY;

        checkCollision();

        anim = requestAnimationFrame(update);
    }

    anim = requestAnimationFrame(update);
}

// COLLISION
function checkCollision() {
    if (roundFinished) return;

    const gateRect = gate.getBoundingClientRect();
    const rocketRect = rocket.getBoundingClientRect();

    const centerY = rocketRect.top + rocketRect.height / 2;

    const hit =
        centerY >= gateRect.top &&
        centerY <= gateRect.bottom;

    if (facing === "right" && rocketRect.right >= gateRect.left)
        endLaunch(hit);

    if (facing === "left" && rocketRect.left <= gateRect.right)
        endLaunch(hit);
}

// END
function endLaunch(success) {

    cancelAnimationFrame(anim);
    anim = null;

    inFlight = false;
    roundFinished = true;

    if (success) {
        hits++;
        hitsCount.textContent = hits;
        document.getElementById("hitsDots").innerHTML += "<span style='color:lime;'>●</span>";
    } else {
        misses++;
        missCount.textContent = misses;
        document.getElementById("missDots").innerHTML += "<span style='color:red;'>●</span>";
    }

    showPopup(success ? "Success!" : "Miss!");
}

// POPUP
function showPopup(text) {
    document.getElementById("popupMessage").textContent = text;
    document.getElementById("popupOverlay").style.display = "flex";
    popupActive = true;
}

document.getElementById("popupBtn").onclick = () => {
    document.getElementById("popupOverlay").style.display = "none";
    popupActive = false;
    resetRocket();
};

// KEYS
document.addEventListener("keydown", e => {
    if (popupActive && e.key === "Enter")
        document.getElementById("popupBtn").click();

    if (e.key === "ArrowLeft") rotateRocket("left");
    if (e.key === "ArrowRight") rotateRocket("right");
    if (e.key === " ") launchRocket();
});

// INIT
resetRocket();
</script>

</body>
</html>
